<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.system.mapper.WorkAttendanceMapper">

    <!-- 实体映射 -->
    <resultMap type="WorkAttendance" id="WorkAttendanceResult">
        <result property="attendanceId" column="attendance_id"/>
        <result property="userId"      column="user_id"/>
        <result property="projectId"   column="project_id"/>
        <result property="attendanceDate" column="attendance_date"/>
        <result property="workingHours"   column="working_hours"/>
        <result property="comment"        column="comment"/>
        <result property="createAt"       column="create_at"/>
        <result property="updateAt"       column="update_at"/>
        <association property="project" javaType="WorkProject" resultMap="projectResult"/>
        <association property="user"    javaType="SysUser"     resultMap="userResult"/>
    </resultMap>

    <!-- 注意：使用别名，避免与主表列重名 -->
    <resultMap type="WorkProject" id="projectResult">
        <result property="projectId"  column="p_project_id"/>
        <result property="name"       column="p_name"/>
        <result property="customerId" column="p_customer_id"/>
    </resultMap>

    <resultMap type="SysUser" id="userResult">
        <id     property="userId"   column="u_user_id"/>
        <result property="userName" column="u_user_name"/>
        <result property="nickName" column="u_nick_name"/>
        <result property="status"   column="u_status"/>
    </resultMap>

    <sql id="selectWorkAttendanceVo">
        select
        att.attendance_id,
        att.user_id as user_id,          -- 保留给主实体
        att.project_id as project_id,    -- 保留给主实体
        att.attendance_date,
        att.working_hours,
        att.comment,
        att.create_at,
        att.update_at,
        -- project 别名
        p.project_id  as p_project_id,
        p.name        as p_name,
        p.customer_id as p_customer_id,
        -- user 别名
        u.user_id   as u_user_id,
        u.user_name as u_user_name,
        u.nick_name as u_nick_name,
        u.status    as u_status
        from work_attendance att
        left join work_project p on att.project_id = p.project_id and p.is_active = 1
        left join sys_user u on att.user_id = u.user_id
    </sql>

    <select id="selectWorkAttendanceList" parameterType="WorkAttendance" resultMap="WorkAttendanceResult">
        <include refid="selectWorkAttendanceVo"/>
        <where>
            <if test="userId != null">            and att.user_id = #{userId}</if>
            <if test="projectId != null">         and att.project_id = #{projectId}</if>
            <if test="attendanceDate != null">    and att.attendance_date = #{attendanceDate}</if>
            <if test="workingHours != null">      and att.working_hours = #{workingHours}</if>
            <if test="comment != null and comment != ''"> and att.comment = #{comment}</if>
            <if test="createAt != null">          and att.create_at = #{createAt}</if>
            <if test="updateAt != null">          and att.update_at = #{updateAt}</if>
            <!-- 按客户过滤（前端已传 project.customerId 或通过 params 映射） -->
            <if test="project != null and project.customerId != null">
                and p.customer_id = #{project.customerId}
            </if>
        </where>
    </select>

    <select id="selectWorkAttendanceListArray" parameterType="WorkAttendanceQuery" resultMap="WorkAttendanceResult">
        <include refid="selectWorkAttendanceVo"/>
        <where>
            <if test="userIds != null and userIds.length > 0">
                and att.user_id in
                <foreach collection="userIds" item="uid" open="(" separator="," close=")">
                    #{uid}
                </foreach>
            </if>

            <if test="projectIds != null and projectIds.length > 0">
                and att.project_id in
                <foreach collection="projectIds" item="pid" open="(" separator="," close=")">
                    #{pid}
                </foreach>
            </if>

            <if test="(projectIds == null or projectIds.length == 0)
                  and customerIds != null and customerIds.length > 0">
                and p.customer_id in
                <foreach collection="customerIds" item="cid" open="(" separator="," close=")">
                    #{cid}
                </foreach>
            </if>

            <!-- 日期范围 -->
            <if test="startTime != null and startTime != '' and endTime != null and endTime != ''">
                and att.attendance_date between #{startTime} and #{endTime}
            </if>
            <if test="startTime != null and startTime != '' and (endTime == null or endTime == '')">
                and att.attendance_date &gt;= #{startTime}
            </if>
            <if test="endTime != null and endTime != '' and (startTime == null or startTime == '')">
                and att.attendance_date &lt;= #{endTime}
            </if>
        </where>
        order by att.attendance_date desc
    </select>


    <select id="selectWorkAttendanceByAttendanceId" parameterType="Long" resultMap="WorkAttendanceResult">
        <include refid="selectWorkAttendanceVo"/>
        where att.attendance_id = #{attendanceId}
    </select>

    <insert id="insertWorkAttendance" parameterType="WorkAttendance" useGeneratedKeys="true" keyProperty="attendanceId">
        insert into work_attendance
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="userId != null">user_id,</if>
            <if test="projectId != null">project_id,</if>
            <if test="attendanceDate != null">attendance_date,</if>
            <if test="workingHours != null">working_hours,</if>
            <if test="comment != null">comment,</if>
            <if test="createAt != null">create_at,</if>
            <if test="updateAt != null">update_at,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="userId != null">#{userId},</if>
            <if test="projectId != null">#{projectId},</if>
            <if test="attendanceDate != null">#{attendanceDate},</if>
            <if test="workingHours != null">#{workingHours},</if>
            <if test="comment != null">#{comment},</if>
            <if test="createAt != null">#{createAt},</if>
            <if test="updateAt != null">#{updateAt},</if>
        </trim>
    </insert>

    <update id="updateWorkAttendance" parameterType="WorkAttendance">
        update work_attendance
        <trim prefix="SET" suffixOverrides=",">
            <if test="userId != null">user_id = #{userId},</if>
            <if test="projectId != null">project_id = #{projectId},</if>
            <if test="attendanceDate != null">attendance_date = #{attendanceDate},</if>
            working_hours = #{workingHours},
            comment = #{comment},
            <if test="createAt != null">create_at = #{createAt},</if>
            <if test="updateAt != null">update_at = #{updateAt},</if>
        </trim>
        where attendance_id = #{attendanceId}
    </update>

    <delete id="deleteWorkAttendanceByAttendanceId" parameterType="Long">
        delete from work_attendance where attendance_id = #{attendanceId}
    </delete>

    <delete id="deleteWorkAttendanceByAttendanceIds" parameterType="String">
        delete from work_attendance where attendance_id in
        <foreach item="attendanceId" collection="array" open="(" separator="," close=")">
            #{attendanceId}
        </foreach>
    </delete>
</mapper>